# M5Stack PCM Audio Recording & Playback

M5StackでPCM形式での高品質音声録音・再生システム

## 概要

このプロジェクトは、M5Stack Core2を使用してPCM形式で音声の録音と再生を行うシステムです。ノイズ除去フィルタ、ゲイン制御、安定した音質を実現しています。

## 特徴

### 🎤 高品質録音
- **16kHz, 16bit PCM**録音
- **3.0倍デジタルゲイン**で小さな音声もクリアに録音
- **ハイパスフィルタ**でDC成分と低周波ノイズを除去
- **ローパスフィルタ**で高周波ノイズを除去
- **ソフトクリッピング**で歪みを防止

### 🔊 クリア再生
- **デジタルゲイン制御**でスピーカー出力を最適化
- **同じフィルタ処理**で一貫した音質
- **安定したタイミング**でスムーズな再生

### 🛡️ ノイズ対策
- **電気ノイズ除去**（50/60Hz電源ノイズ対策）
- **サンプルレート安定化**（異常値の自動補正）
- **バッファアンダーラン防止**（2048サンプルバッファ）

## 使用方法

### ハードウェア
- **M5Stack Core2**
- **SDカード**（音声ファイル保存用）

### 操作
- **ボタンA**: 5秒間録音 → `/mic.pcm`に保存
- **ボタンB**: 保存された音声を再生

## 技術仕様

### 音声設定
```cpp
サンプルレート: 16000Hz (自動調整)
ビット深度: 16bit
チャンネル: モノラル
録音時間: 5秒
ファイル形式: PCM (カスタムヘッダ付き)
```

### ゲイン設定
```cpp
static constexpr float REC_GAIN = 3.0f;   // 録音ゲイン
static constexpr float PLAY_GAIN = 1.0f;  // 再生ゲイン
```

### バッファ設定
```cpp
static constexpr size_t CHUNK = 2048;  // 2048サンプル (128ms@16kHz)
```

## フィルタ仕様

### ハイパスフィルタ
- **カットオフ**: 約50Hz @ 16kHz
- **目的**: DC成分と低周波ノイズ除去
- **alpha値**: 0.995

### ローパスフィルタ
- **カットオフ**: 約1.6kHz @ 16kHz  
- **目的**: 高周波ノイズとエイリアシング除去
- **alpha値**: 0.8

## PCMファイル形式

独自の軽量ヘッダ付きPCM形式：

```cpp
struct PcmHeader {
    char magic[4];        // "PCM1"
    uint32_t sample_rate; // 16000
    uint8_t channels;     // 1
    uint8_t bits;         // 16
    uint16_t frame_samps; // 320 (参考情報)
    uint16_t reserved;    // 0
};
```

## カスタマイズ

### ゲイン調整
音声レベルを調整したい場合：

```cpp
// 録音を大きくしたい場合
static constexpr float REC_GAIN = 4.0f;  // 1.0f～5.0f推奨

// 再生を大きくしたい場合  
static constexpr float PLAY_GAIN = 2.0f; // 1.0f～3.0f推奨
```

### 録音時間変更
```cpp
static constexpr int REC_SEC = 10; // 10秒録音
```

### フィルタ調整
```cpp
// ハイパスフィルタをより強くしたい場合
float alpha = 0.98f; // カットオフ ≈ 160Hz

// ローパスフィルタをより緩くしたい場合
float alpha = 0.9f;  // カットオフ ≈ 800Hz
```

## トラブルシューティング

### 音質問題

**機械的な音質**
- サンプルレート不整合の可能性
- setup()で測定値を確認してください

**音が小さい**
- `REC_GAIN`と`PLAY_GAIN`を増加
- スピーカー音量設定も確認

**ノイズが多い**
- SDカードの品質を確認
- 電源供給の安定性を確認
- フィルタのalpha値を調整

**音が途切れる**
- `CHUNK`サイズを4096に増加
- CPUの負荷を軽減

### エラー対処

**"SD init FAILED"**
- SDカードが正しく挿入されているか確認
- SDカードのフォーマット（FAT32推奨）

**"REC FAILED" / "PLAY FAILED"**
- マイクの接続を確認
- ファイルの存在を確認
- SDカードの容量を確認

## 開発環境

- **PlatformIO**
- **M5Unified Library**
- **ESP32 Arduino Framework**

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 更新履歴

### v1.2 (最新)
- デジタルゲイン制御追加（録音・再生両対応）
- ソフトクリッピング機能追加
- ノイズ除去フィルタ改善

### v1.1
- バッファサイズ最適化（1024→2048サンプル）
- サンプルレート安定化機能追加
- ローパスフィルタ調整

### v1.0
- 基本的な録音・再生機能
- ハイパスフィルタ・ローパスフィルタ実装